@model (Cinema? Cinema, Dictionary<Movie, Dictionary<Experience, List<Showtime>>> Results)

@if (Model.Cinema != null)
{
    <div class="showtime-header-container">
        <div class="showtime-selected-cinema-name">@Model.Cinema.Name</div>
        <a href="/Cinema/Info/@Model.Cinema.Slug" class="showtime-info-button"></a>
        <img src="/img/seat/green.png">
        <div class="showtime-header-sales-info">Available</div>
        <img src="/img/seat/yellow.png">
        <div class="showtime-header-sales-info">Selling Fast</div>
        <img src="/img/seat/red.png">
        <div class="showtime-header-sales-info">Sold Out</div>
        <div id="showtime-filter" data-link>Filter by</div>
    </div>


    <div class="showtime-body-container">
        @if (Model.Results.Count > 0)
        {
            bool initShowtime = false;
            foreach (var group in Model.Results)
            {
                var movies = group.Key;
                var results = group.Value;

                if (initShowtime)
                {
                    <div class="divider-horizontal"></div>
                }
                else
                {
                    initShowtime = true;
                }

                <div class="showtime-movie">
                    <img src="/uploads/poster/@movies.Poster" class="showtime-movie-poster">
                    <div class="showtime-movie-info-container">
                        <h2 class="showtime-movie-title">@movies.Title</h2>
                        <div class="showtime-movie-info">
                            @string.Join(", ", movies.Genres.Select(g => g.Name))
                            &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
                            @FormatService.ToDurationFormat(movies.Duration)
                            &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
                            @movies.SpokenLanguage.Name
                        </div>
                        <br>
                        <a href="/Movie/Info/@movies.Slug" data-button="outline">View Info</a>
                        @if (!string.IsNullOrEmpty(movies.Trailer))
                        {
                            <br>
                            <br>
                            <a href="@movies.Trailer" target="_blank" data-button="yellow">Watch Trailer</a>
                        }

                        @foreach (var experience_group in results)
                        {
                            var experience = experience_group.Key;
                            var showtimes = experience_group.Value;

                            <div class="showtime-experience">
                                <img src="/img/experience/@(experience.Name).png">
                                <a href="/Experience/Info/@experience.Slug" class="showtime-info-button"></a>
                            </div>
                            <div class="showtime-time-container">
                                @foreach (var showtime in showtimes)
                                {
                                    int soldSeatsCount = showtime.Bookings
                                    .Where(b => b.Status == "Confirmed")
                                    .SelectMany(b => b.Tickets)
                                    .Select(t => t.SeatId)
                                    .Distinct()
                                    .Count();
                                    int availableSeatsCount = showtime.Hall.Seats.Count(s => !s.IsDeleted);

                                    string className = "";
                                    if (soldSeatsCount == availableSeatsCount)
                                    {
                                        className = "sold-out";
                                    }
                                    else if ((double)soldSeatsCount / availableSeatsCount >= 0.8)
                                    {
                                        className = "selling-fast";
                                    }

                                    <a href="/Booking/Create/@showtime.Id">
                                        <span class="@className">@FormatService.ToDateTimeFormat(showtime.StartTime, "hh:mm tt")</span>
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <partial name="_NoResults" model="@("No Showtimes Found")" />
        }
    </div>
}